name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  CONTAINER_NAME: belajarcicd-stg
jobs:
  Build-Test-Push:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Auth Docker
        run: |
          docker login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} $REGISTRY
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Building Docker Image
        run: docker build --tag ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} .
      - name: Testing docker image
        run: docker run --rm ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} sleep 1
      - name: Push Docker Image
        run: docker push ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}
  Deploy-to-Staging:
    runs-on: ubuntu-latest
    needs: Build-Test-Push
    env:
      DOCKER_HOST: ssh://${{ secrets.SSH_USERNAME_STG }}@${{ secrets.SSH_HOST_STG }}
    steps:
      - name: Setup SSH Client
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_STG }}
      - name: Bypass SSH Host Key Checking
        run: |
          mkdir -p ~/.ssh
          echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
      - name: Pull Docker Image
        run: docker pull ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}
      - name: Stop and Remove Existing Container
        run: |
          docker container stop $CONTAINER_NAME || true
          docker container rm $CONTAINER_NAME || true
      - name: Deploy
        run: |
          docker run --detach --label traefik.enable=true \
          --name $CONTAINER_NAME ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}
