name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  CONTAINER_NAME: belajarcicd-stg
jobs:
  Build-Test-Push:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Auth Docker
        run: |
          docker login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} $REGISTRY
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Building docker image
        run: docker build --tag ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7} .
      - name: Testing docker image
        run: sleep 1
      - name: Push docker image
        run: docker push ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}
  Deploy-to-Staging:
    runs-on: ubuntu-latest
    needs: Build-Test-Push
    # permissions:
    #   packages: read
    steps:
      # - name: Setup SSH Private Key 
      #   run: |
      #     eval $(ssh-agent -s)
      #     ssh-add <(echo "${{ secrets.SSH_PRIVATE_KEY }}")
      #     mkdir -p ~/.ssh
      #     echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Setup Docker Host 
        run: export DOCKER_HOST=ssh://ubuntu@13.212.189.175
    
      # - name: Auth Docker
      #   run: |
      #     docker login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} $REGISTRY
      - name: Stop and Remove Existing Container
        run: |
          docker container stop $CONTAINER_NAME || true
          docker container rm $CONTAINER_NAME || true
      - name: Pull Docker Image
        run: |
          export DOCKER_HOST=ssh://ubuntu@13.212.189.175
          docker pull ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}
      - name: Deploy
        run: |
          export DOCKER_HOST=ssh://ubuntu@13.212.189.175
          docker run --detach --publish 80:3000 --name $CONTAINER_NAME ${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}
